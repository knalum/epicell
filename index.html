<!DOCTYPE html>
<html>
<head>
    <title>epicell</title>
    <script type="text/javascript" src="js/zepto.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<h3>
    epicell
</h3>
<div class="panel">
    A simplified cellular automata simulator for modelling the dynamics of infectious disease.
</div>

<div class="panel">
    <table>
        <tr>
            <td>
                Cells
            </td>
            <td>
                <span id="cells"></span>
            </td>
			<td>
				Days
			</td>
			<td>
				<span id="days"></span>
			</td>
        </tr>

        <tr>
            <td class="susceptible">
                Susceptible
            </td>
            <td class="susceptible">
                <span id="susceptibleCells"></span>
            </td>
            <td class="infected">
                Infected
            </td>
            <td class="infected">
                <span id="infectedCells"></span>
            </td>
            <td class="recovered">
                Recovered
            </td>
            <td class="recovered">
                <span id="recoveredCells"></span>
            </td>
        </tr>

        <tr>
            <td>
                Calc [ms]
            </td>
            <td>
                <span id="calcTime"></span>
            </td>
            <td>
                Draw [ms]
            </td>
            <td>
                <span id="drawTime"></span>
            </td>
        </tr>

		<tr>
			<td>
				Interval [ms]
			</td>
			<td>
				<input type="number" id="interval" placeholder="sim interval" value="50"/>
			</td>
		</tr>
    </table>
</div>

<button id="reset">Reset</button>
<button id="step">Step</button>
<button id="start">Start</button>
<button id="stop">Stop</button>
<br/>
<br/>

<canvas id="myCanvas" width="600" height="600" style="border: 1px solid black"></canvas>
<script>
    // Globals
    const SZ_X = 10
    const SZ_Y = 10

    const GRID_X = 60
    const GRID_Y = 60

	const RECOVERY_TIME = 14

    const CSTATE = {
        S: 2,
        I: 1,
        B: 0,
        R: 3
    }
    //-------


    let app = {
        canvas: undefined,
        ctx: undefined,
        grid: [],
        isRunning: false,
        timer: undefined,
		days:0,
        init: function () {
            this.canvas = document.getElementById("myCanvas");
            this.ctx = this.canvas.getContext("2d");
            this.grid = initGrid()
			this.days=0
        },
        run: function () {
            if (!this.canvas) this.init()


            const t1 = new Date().getTime()
            calcGrid(this.ctx, this.grid)
            const t2 = new Date().getTime()

            const calcTime = t2 - t1

            drawGrid(this.ctx, this.grid)
            const t3 = new Date().getTime()
            const drawTime = t3 - t2


            $("#drawTime").text(drawTime)
            $("#calcTime").text(calcTime)

			this.days++
			$("#days").text(this.days)
        },
        start: function () {
        	const INTERVAL_MS = $("#interval").val()

            if (this.isRunning) {
                return
            }
            var self = this
            this.timer = setInterval(function () {
                self.run()
            }, INTERVAL_MS)

            this.isRunning = true
        },
        stop: function () {
            if (!this.timer) {
                return
            }
            clearInterval(this.timer)
            this.isRunning = false
        },
        reset: function () {
            this.init()
        }
    }

    app.run()

    // Handlers
    $("#reset").click(function () {
        location.reload()
    })
    $("#step").click(function () {
        app.run()
    })
    $("#start").click(function () {
        app.start()
    })
    $("#stop").click(function () {
        app.stop()
    })

    //-----


    function calcGrid(context, grid) {
        let stats = {}
        stats[CSTATE.S] = 0
        stats[CSTATE.I] = 0
        stats[CSTATE.R] = 0

        let sick = []

        for (let i = 0; i < GRID_X; ++i) {
            for (let j = 0; j < GRID_Y; ++j) {
                if (grid[i][j].state !== CSTATE.B) {
                    sick.push({
                        x: i,
                        y: j,
						state:grid[i][j].state
                    })

                    stats[grid[i][j].state]++
                }

            }
        }


        $("#susceptibleCells").text(stats[CSTATE.S])
        $("#infectedCells").text(stats[CSTATE.I])
        $("#recoveredCells").text(stats[CSTATE.R])
        $("#cells").text(sick.length)

        for (let i = 0; i < sick.length; ++i) {
            let pos = {}
            const dir = Math.floor(Math.random() * 4)
            if (dir === 0) {
                pos.x = 0;
                pos.y = -1
            }
            else if (dir === 1) {
                pos.x = 1;
                pos.y = 0
            }
            else if (dir === 2) {
                pos.x = 0;
                pos.y = 1
            }
            else if (dir === 3) {
                pos.x = -1;
                pos.y = 0
            }
            else console.error("Error dir: " + dir)


            const newX = sick[i].x + pos.x
            const newY = sick[i].y + pos.y

			// Infected, increase number of infected days
			if (sick[i].state === CSTATE.I ) {
				grid[sick[i].x][sick[i].y].days++

				if( grid[sick[i].x][sick[i].y].days > RECOVERY_TIME ){
					grid[sick[i].x][sick[i].y].state = CSTATE.R
				}
			}

			// Out of bounds.
            if (newX < 0 || newX >= GRID_X || newY < 0 || newY >= GRID_Y) {
                continue;
            }

            // Infection
			if ( sick[i].state === CSTATE.I ){
				infect(sick[i],grid,1,0)
				infect(sick[i],grid,-1,0)
				infect(sick[i],grid,0,1)
				infect(sick[i],grid,0,-1)

				infect(sick[i],grid,1,1)
				infect(sick[i],grid,1,-1)
				infect(sick[i],grid,-1,1)
				infect(sick[i],grid,-1,-1)

			}

            // Movement
            if (grid[newX][newY].state === CSTATE.B ) {

                let oldCell = grid[sick[i].x][sick[i].y]
                grid[sick[i].x][sick[i].y] = {
                    state: CSTATE.B,
                    days: 0
                }
                grid[newX][newY] = {
                    state: oldCell.state,
                    days: oldCell.days
                }
            }

        }
    }

    function infect(sick,grid,dx,dy){
    	let x = sick.x+dx
    	let y = sick.y+dy
		if( x>=0 && x< GRID_X && y>=0 && y<GRID_Y ){
			if( grid[x][y].state === CSTATE.S ){
				grid[x][y].state = CSTATE.I
				grid[x][y].days = 0
			}
		}
	}


    function drawGrid(context, grid) {
        context.clearRect(0, 0, 600, 600);

        let cnt = 0
        for (let i = 0; i < GRID_X; ++i) {
            for (let j = 0; j < GRID_Y; ++j) {
                if (grid[i][j].state === CSTATE.B) {
                    drawBlank(i, j, context)
                } else if (grid[i][j].state === CSTATE.S) {
                    drawGreen(i, j, context)
                } else if (grid[i][j].state === CSTATE.I) {
                    drawRed(i, j, context)
                } else if (grid[i][j].state === CSTATE.R) {
                    drawBlue(i, j, context)
                } else {
                    console.error("Error at " + i + " " + j)
                }
                cnt++
            }
        }


    }

    function drawRed(i, j, context) {
        context.fillStyle = "red";
        context.fillRect(i * SZ_X, j * SZ_Y, SZ_X, SZ_Y);
    }

    function drawBlank(i, j, context) {
        context.fillStyle = "rgb(240,240,240)";
        context.strokeRect(i * SZ_X, j * SZ_Y, SZ_X, SZ_Y);
    }

    function drawGreen(i, j, context) {
        context.fillStyle = "green";
        context.fillRect(i * SZ_X, j * SZ_Y, SZ_X, SZ_Y);
    }

    function drawBlue(i, j, context) {
        context.fillStyle = "blue";
        context.fillRect(i * SZ_X, j * SZ_Y, SZ_X, SZ_Y);
    }

    function initGrid() {
        let grid = []
        for (let i = 0; i < GRID_X; ++i) {
            let row = []
            for (let j = 0; j < GRID_Y; ++j) {

                let rand = Math.random() * 1000
                if (rand > 995) {
                    row.push({
                        state: CSTATE.I,
                        days: 0
                    })
                } else if (rand > 890 && rand < 995) {
                    row.push({
                        state: CSTATE.S,
                        days: 0
                    })
                } else {
                    row.push({
                        state: CSTATE.B
                    })
                }

            }
            grid.push(row)

        }

        return grid
    }

</script>

<div class="footer">
    epicell 2020 - knalum - contact
</div>
</body>
</html>